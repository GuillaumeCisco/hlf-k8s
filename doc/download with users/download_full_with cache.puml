@startuml

skinparam shadowing false


package "Node A" as nodeA {
   rectangle "peer" as peerA {
    database ledgerA [
      ledger
      ----
      ----
    ]
  }
  rectangle "substrabac" as substrabacA {
    database localdbA [
      local db
      ----
      USER_A1
      ----
    ]
    node server as djangoA
  }
  rectangle "Fabric CA" as fcaA {
    rectangle db as fcadbA {
        database usersA [
            users
            ----
            ----
        ]
        file {
            card USER_A
            card NODE_A_USER_B
        }
    }
    node server as fcaserverA
  }
}

package "Node B" as nodeB {
   rectangle "peer" as peerB {
    database ledgerB [
      ledger
      ----
      ----
    ]
  }
  rectangle "substrabac" as substrabacB {
    database localdbB [
      local db
      ----
      ----
    ]
    node server as djangoB
  }
  rectangle "Fabric CA" as fcaB {
    rectangle db as fcadbB {
        database usersB [
            users
            ----
            ----
        ]
        file {
            card USER_B
            card NODE_B_USER_A #PHYSICAL
        }
    }
    node server as fcaserverB
  }
}

actor "client from Node A\n USER_A1" as client

nodeA -[hidden]---> nodeB

USER_B -[hidden]r- NODE_B_USER_A
USER_A -[hidden]r- NODE_A_USER_B

djangoA <-[#orange]> localdbA

fcaserverB <-[#orange]> usersB
fcaserverA <-[#orange]> usersA

client .> djangoA: "1. credentials in\nsession_id\nfrom login\n+url in GET\non /download"

djangoA ..> djangoA: \n\n\n\n<font color="red">2. check session_id</font>\n<font color="red">3. check if asset in cache</font>\n<font color="red">5. precheck</font>\n<font color="red">12. put in cache</font>

djangoA -> peerA: 4. get asset for precheck
djangoA <.[#green]. peerA

djangoA .> djangoB: 6. use credentials from\n Node A (NODE_B_USER_A)
djangoA <.[#green]. djangoB

djangoB .> ledgerB: 7. get asset for check
djangoB <.[#green]. ledgerB

djangoB <-> fcaserverB: 8.enroll user

djangoB ..> djangoB: \n\n\n\n<font color="red">9. check asset permissions</font>\n<font color="red">on Internal User with right</font>\n<font color="red">modulus and permission</font>\n<font color="red">11. send file content</font>

djangoB <-[#orange]> localdbB: 10. get local object

client <.[#green]. djangoA: 13. file content

@enduml
